RocketDrive.BackupAgent — Quick Install & Release Notes
------------------------------------------------------

RocketDrive is a lightweight Windows backup agent that uploads local backup files to Google Drive.
Designed to be small, reliable and easy to deploy on low-spec Windows machines (Win7+).

This README contains:
- Release build commands (how the single EXE is produced)
- What’s in this release
- Pre-requisites
- Install & first-run steps (end-user)
- Scheduling (Task Scheduler)
- Security notes
- Troubleshooting
- Contact / Next steps

----------------------------------------------------------------------
1) RELEASE - how this single EXE was (or should be) produced
----------------------------------------------------------------------

.NET Framework 4.8 (32-bit) build (x86) — use when target machines are 32-bit:
  dotnet publish -c Release -f net48 -p:Platform=x86

> NOTE: To embed managed DLLs into one single EXE for net48 you must add Costura (Fody) to the project:
>  - dotnet add package Fody --version 6.*
>  - dotnet add package Costura.Fody --version 5.*
>  - add FodyWeavers.xml with <Costura .../> next to the .csproj
> When Costura is configured, the net48 publish produces a single EXE that includes managed DLLs.

.NET 6.0 (self-contained single-file EXE) build — recommended for modern machines:
  dotnet publish -c Release -f net6.0 -r win-x64 --self-contained true -p:PublishSingleFile=true

The above commands produce one runnable EXE (net6 self-contained) or a net48 EXE (when Costura is enabled).
After publishing, copy the contents of the publish folder to your release folder.

----------------------------------------------------------------------
2) WHAT YOU SHOULD HAVE IN THE RELEASE FOLDER
----------------------------------------------------------------------
Place the following files together (root of your install folder, e.g. C:\RocketDriveBackup\):

  RocketDrive.BackupAgent.exe    <-- single exe (from publish)
  RunRocketDrive.cmd             <-- launcher script (sets working dir)
  appsettings.json               <-- user configuration (generated by builder or hand-edit)
  credentials.json               <-- Google OAuth client (Desktop type)
  AppSettingsBuilder.html        <-- optional GUI to create appsettings.json
  README.txt                     <-- this file
  logs\                          <-- directory created at runtime (optional in release zip)

Recommended: Put runtime data (last_uploaded, status.json, token.json) under:
  C:\ProgramData\RocketDriveBackup\   (update appsettings.json if needed)

----------------------------------------------------------------------
3) PREREQUISITES (client machine)
----------------------------------------------------------------------
- net6.0 self-contained build: No .NET runtime required.
- net48 build: .NET Framework 4.8 must be installed on the client.
- A web browser (for first-run Google OAuth).
- Telegram (optional) if you want Telegram notifications.

----------------------------------------------------------------------
4) QUICK INSTALL & FIRST RUN (for non-technical users)
----------------------------------------------------------------------
1. Copy the release folder to the client machine, e.g.:
   C:\RocketDriveBackup\

2. Configure:
   - Option A (easy): Double-click AppSettingsBuilder.html, fill fields (Folders to back up, Allowed extensions, TargetDriveFolderName, Telegram/SMTP) and click "Download" to get appsettings.json. Save it in the same folder as the EXE.
   - Option B (manual): Edit appsettings.json with a text editor.

   Important appsettings keys:
     - BackupSettings.Folders : array of folder paths to watch
     - BackupSettings.AllowedExtensions : array like [".zip", ".bak"]
     - BackupSettings.LastUploadedFileTimePath : path to file that stores last timestamp
     - BackupSettings.StatusFilePath : path to status.json
     - Telegram (Enabled/BotToken/ChatId) or Smtp (Enabled/Host/Port/From/To/Username/Password)

3. Place credentials.json (your Google OAuth Desktop client file) in the same folder.
   - Use OAuth client type "Desktop".
   - Keep credentials.json readable by the user account that will run the task.

4. First run (authenticate Google):
   - Double-click RunRocketDrive.cmd
     (This ensures the working folder is the app folder and launches the EXE.)
   - A browser window will open to sign in and grant Drive permissions (drive.file recommended).
   - After consent, token.json will be created (by default alongside the EXE or at configured token path).
   - Check logs\ and status.json for run results and to confirm upload.

5. Verify:
   - Open Google Drive and confirm the TargetDriveFolderName exists and files uploaded.
   - Check Telegram/email if configured.

----------------------------------------------------------------------
5) SETUP AUTOMATIC RUN (Task Scheduler)
----------------------------------------------------------------------
Recommended: use Task Scheduler to run periodically (every hour or every 5 minutes).

Option A — GUI (recommended for new users)
  1. Open Task Scheduler -> Create Task...
  2. General:
     - Name: RocketDrive Hourly (or RocketDrive Every5Min)
     - Choose "Run only when user is logged on" if your Windows account has no password.
     - Check "Run with highest privileges".
  3. Triggers -> New:
     - Begin the task: On a schedule -> Daily
     - Start: set a time
     - Repeat task every: 1 hour (or 5 minutes)
     - For a duration of: 1 day
     - Enabled
  4. Actions -> New:
     - Program/script: C:\RocketDriveBackup\RunRocketDrive.cmd
  5. Settings:
     - If the task is already running: Queue a new instance
     - Run task as soon as possible after a scheduled start is missed

Option B — One-line helper script (interactive token; requires user logged in)
  - Save the following as create-task-every5min.cmd next to RunRocketDrive.cmd and run it:
    schtasks /Create /TN "RocketDrive Every5Min" /TR "\"%~dp0RunRocketDrive.cmd\"" /SC MINUTE /MO 5 /RL HIGHEST /F /IT

Notes:
- /IT uses interactive token — task runs only when that user is logged on (no password required).
- To run when no user is logged in you must create the task with stored credentials (will ask for a password).

----------------------------------------------------------------------
6) WHERE TOKENS/CONFIG ARE STORED & SECURITY RECOMMENDATIONS
----------------------------------------------------------------------
- credentials.json : contains client_id/client_secret for your Desktop OAuth client (public client). OK to distribute with app.
- token.json : contains user's refresh token (sensitive). Protect it:
  - Store token.json under a restricted folder, e.g.:
      C:\ProgramData\RocketDriveBackup\secrets\token.json
  - Restrict NTFS permissions to the account that runs the scheduled task.
  - Optionally encrypt token.json using Windows DPAPI (ProtectedData.Protect/Unprotect).
    - Use DataProtectionScope.CurrentUser if the task runs as that user, or LocalMachine for machine-wide (less secure).
- Do not log credentials or tokens. Verify Serilog settings do not print secrets.

Recommended minimum scope:
  - use "https://www.googleapis.com/auth/drive.file" — allows creating and managing files your app creates.

----------------------------------------------------------------------
7) LOGS & STATUS
----------------------------------------------------------------------
- Logs: logs\log-YYYY-MM-DD.json (Serilog structured JSON)
- Status snapshot: status.json (written each run) contains:
  - StartedUtc, FinishedUtc, FilesScanned, FilesUploaded, SkippedExisting, SkippedUnstable, Errors

Quick check:
  - If something failed, open logs\latest log and status.json to see error details.

----------------------------------------------------------------------
8) TROUBLESHOOTING (common issues)
----------------------------------------------------------------------

Q: Task runs manually but not on schedule?
A:
  - If Task Scheduler uses "Run only when user is logged on", ensure you are logged in.
  - Check Task Scheduler History tab for errors and Last Run Result code.
  - Confirm trigger is set to Repeat every: X minutes, Duration: 1 day.
  - Set "If the task is already running" to Queue a new instance if run time can overlap.

Q: Google shows "App is being tested / not verified"?
A:
  - Add user account as Test user in Google Cloud -> OAuth consent screen OR publish app to Production and follow verification if required.

Q: Files upload every run (duplicates)?
A:
  - Ensure last_uploaded timestamp file is written in UTC and comparisons are done using FileInfo.LastWriteTimeUtc.
  - If code mixes local and UTC times it will cause repeated uploads.

Q: SMTP: Authentication required?
A:
  - Use App Password (Gmail) with 2FA on and SMTP port 587 + TLS.
  - Ensure UseSsl true and .NET is using TLS1.2 (for net48 you may need ServicePointManager.SecurityProtocol = (SecurityProtocolType)3072).

Q: Telegram not delivering messages?
A:
  - Ensure you /start the bot in Telegram.
  - Verify BotToken and ChatId (getUpdates) are correct.
  - Make sure Telegram.Enabled = true in appsettings.json.

----------------------------------------------------------------------
9) UNINSTALL
----------------------------------------------------------------------
1. Delete the scheduled task in Task Scheduler.
2. Delete the installed folder (e.g., C:\RocketDriveBackup\).
3. Optionally revoke app access from Google Account -> Security -> Third-party access.

----------------------------------------------------------------------
10) DEPENDENCIES & DEV NOTES (for maintainers)
----------------------------------------------------------------------
- Project targets: net48 (for Win7 compatibility) and net6.0 (modern).
- NuGet packages used (examples):
  - Google.Apis.Drive.v3
  - Google.Apis.Auth
  - Serilog, Serilog.Sinks.File, Serilog.Sinks.Console, Serilog.Sinks.Async
  - (net48 single-exe) Fody & Costura.Fody
- For net48 single-EXE embedding, ensure Costura is configured (see section 1).
- For net6.0 single-file, use the dotnet publish command above.

Suggested production workflow:
  1) Build net48 x86: dotnet publish -c Release -f net48 -p:Platform=x86
  2) (If desired) Add Costura to embed DLLs or use net6 self-contained build
  3) Build net6 self-contained single EXE: dotnet publish -c Release -f net6.0 -r win-x64 --self-contained true -p:PublishSingleFile=true
  4) Zip the publish folder contents along with appsettings.json, credentials.json, RunRocketDrive.cmd and AppSettingsBuilder.html and upload release zip.

----------------------------------------------------------------------
11) CONTACT / NEXT STEPS
----------------------------------------------------------------------
If you want:
- a short user-friendly README.txt to include with client zip (I provided one here),
- an installer (Inno Setup) to place files and create the scheduled task automatically,
- or automatic DPAPI encryption for token.json on first run — I can add those helpers.

Thank you — RocketDrive.BackupAgent
